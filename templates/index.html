{% extends "base.html" %}
{% load static %}
{% block content %}

<section class="relative w-full h-[50vh] flex items-center justify-center overflow-hidden">
    <img src="{% static 'images/mars_bg.jpg' %}"
         class="absolute inset-0 w-full h-full object-cover opacity-40">
    <div class="absolute inset-0 bg-gradient-to-b from-white/60 via-white/80 to-white"></div>

    <div class="relative z-10 text-center px-6">
        <h1 class="text-4xl md:text-5xl font-extrabold text-orange-500 drop-shadow-xl animate-slide-down">
            Mars Shop
        </h1>
        <p class="text-slate-600 text-lg mt-4 animate-fade-in max-w-xl mx-auto">
            Каталог марсианских товаров с поиском, фильтрами и сортировкой.
        </p>
    </div>
</section>

<section class="container mx-auto px-4 py-10">

    <!-- Фильтры / поиск -->
    <form method="get"
          class="grid md:grid-cols-4 gap-4 mb-8 bg-white shadow-md p-4 rounded-2xl border border-orange-100">
        <div>
            <label class="filter-label">Поиск товара</label>
            <input type="text" name="q" value="{{ search_query }}" class="filter-input"
                   placeholder="Название или описание">
        </div>
        <div>
            <label class="filter-label">Цена от</label>
            <input type="number" step="0.01" name="min_price" value="{{ min_price }}" class="filter-input">
        </div>
        <div>
            <label class="filter-label">Цена до</label>
            <input type="number" step="0.01" name="max_price" value="{{ max_price }}" class="filter-input">
        </div>
        <div>
            <label class="filter-label">Сортировка</label>
            <select name="sort" class="filter-input">
                <option value="new" {% if current_sort == 'new' %}selected{% endif %}>Сначала новые</option>
                <option value="price_asc" {% if current_sort == 'price_asc' %}selected{% endif %}>Цена ↑</option>
                <option value="price_desc" {% if current_sort == 'price_desc' %}selected{% endif %}>Цена ↓</option>
            </select>
        </div>
        <div class="md:col-span-4 flex justify-end gap-3 mt-1">
            <button type="submit" class="btn-primary px-6 py-2 text-sm">
                Поиск
            </button>
            <a href="{% url 'index' %}"
               class="px-4 py-2 text-sm border border-slate-300 rounded-xl hover:bg-slate-100">
                Сбросить
            </a>
        </div>
    </form>

    <!-- Категории -->
    <div class="flex flex-wrap gap-3 justify-center mb-8">
        <a href="{% url 'index' %}"
           class="filter-pill {% if not active_category %}filter-pill-active{% endif %}">
            Все
        </a>
        {% for cat in categories %}
            <a href="?category={{ cat.id }}{% if search_query %}&q={{ search_query }}{% endif %}"
               class="filter-pill {% if active_category == cat.id %}filter-pill-active{% endif %}">
                {{ cat.name }}
            </a>
        {% endfor %}
    </div>

    <!-- Список товаров -->
    <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
        {% if page_obj.object_list %}
            {% static 'images/placeholder.png' as placeholder_img %}
            {% for product in page_obj.object_list %}
                <div class="product-card animate-fade-in">
                    <img src="{{ product.photo_url|default:placeholder_img }}"
                         class="h-56 w-full object-cover" alt="{{ product.name }}">
                    <div class="product-info">
                        <h3 class="product-title">
                            {{ product.name }}
                        </h3>
                        <p class="product-desc">
                            {{ product.description|default:"Нет описания"|truncatewords:14 }}
                        </p>

                        <div class="flex justify-between items-center mt-4">
                            <span class="price">{{ product.price }} ₽</span>
                            <div class="flex flex-col gap-2 items-end">
                                <button type="button"
                                        onclick="addToCart({{ product.id }})"
                                        class="btn-primary px-4 py-2 text-sm">
                                    В корзину
                                </button>
                                <a href="{% url 'product_detail' product.id %}"
                                   class="text-xs text-slate-500 hover:text-orange-500">
                                    Подробнее →
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="col-span-full text-center text-slate-500 text-lg">
                Товары не найдены
            </p>
        {% endif %}
    </div>

    <!-- Пагинация -->
    {% if page_obj.paginator.num_pages > 1 %}
        <div class="mt-8 flex justify-center gap-2">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="page-btn">
                    ← Назад
                </a>
            {% endif %}
            <span class="page-info">
                Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
            </span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="page-btn">
                    Вперёд →
                </a>
            {% endif %}
        </div>
    {% endif %}
</section>

<!-- ПУБЛИЧНЫЙ ДАШБОРД -->
<section class="container mx-auto px-4 pb-16">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-orange-600">
            Статистика продаж
        </h2>
        <div class="flex gap-2">
            <button type="button"
                    class="filter-pill filter-pill-active"
                    data-range-days="7">
                7 дней
            </button>
            <button type="button"
                    class="filter-pill"
                    data-range-days="30">
                30 дней
            </button>
            <button type="button"
                    class="filter-pill"
                    data-range-days="90">
                90 дней
            </button>
        </div>
    </div>

    <p class="text-sm text-slate-500 mb-6">
        Здесь можно увидеть общую динамику выручки и вклад категорий.
    </p>

    <div class="grid md:grid-cols-2 gap-6">
        <div class="dashboard-card">
            <h3 class="dashboard-card-title">Выручка по дням</h3>
            <canvas id="mainRevenueChart"></canvas>
        </div>
        <div class="dashboard-card">
            <h3 class="dashboard-card-title">Категории по выручке</h3>
            <canvas id="mainCategoryChart"></canvas>
        </div>
    </div>
</section>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/cart.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof initMainDashboard === "function") {
            initMainDashboard();
        }
    });
</script>
{% endblock %}
